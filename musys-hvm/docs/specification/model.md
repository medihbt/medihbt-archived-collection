# Musys-HVM 虚拟机模型描述

## 存储模型

### 寄存器空间

### 栈空间

### 堆空间

### 全局读写空间

### 线程本地读写空间

### 只读空间

## 数据处理模型

### 数据类型

为简化实现, Musys-HVM 只能在 8 位一字节的机器上运行, 目前只适用于 64 位机器. 以下介绍一些基础数据类型和基本拓展数据类型.

基础数据类型是指一个寄存器就能容纳的数据类型，包括以下几类:

> 整数; 指针; 浮点数

拓展数据类型是由基础类型搭建得到的类型, 包括:

> 胖指针 (数组、接口)
> 结构体

#### 整数和指针

Musys-HVM 中的整数类型定义是为存储特化的, 大小都可以写成 2^n (n 为自然数) 字节的形式. 整数存储类都是无符号的. 整数类型有这些:

- **字节**: 等价于 C 类型 uint8_t,  大小 1 字节, 对齐 1 字节. 可以用于模拟布尔类型.
  - 常用指令后缀：`b`
  - Musys-HVM 类型: `Musys.HVM.Storage.Byte`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.BYTE`
- **半字**: 等价于 C 类型 uint16_t, 大小 2 字节, 对齐 2 字节.
  - 常用指令后缀: `h`
  - Musys-HVM 类型: `Musys.HVM.Storage.HfWord`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.HF_WORD`
- **字**: 等价于 C 类型 uint32_t, 大小 4 字节, 对齐 4 字节.
  - 常用指令后缀: `w`
  - Musys-HVM 类型: `Musys.HVM.Storage.Word`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.WORD`
- **双字**: 等价于 C 类型 uint64_t, 大小 8 字节, 对齐 8 字节.
  - 常用指令后缀: `d`
  - Musys-HVM 类型: `Musys.HVM.Storage.BiWord`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.BI_WORD`

在运行时，这些整数类型的大小端取决于机器的大小端. 例如, `x86_64` 机器上的整数都是小端的, `arm32be` 上的整数都是大端的. 在二进制字节码中，所有整数都要按照小端存储.

大于双字的整数局部变量应当存储在栈空间而不是寄存器里.

为实现结构体、数组等等, Musys-HVM 还支持指针类型.

- **指针**: 等价于 C 类型 void*. 可以指向栈对象、堆对象, 不能指向寄存器. 可以作为整数, 此时要么是字(32位系统), 要么是双字(64位系统).
  - 常用指令后缀: `p`
  - Musys-HVM 类型: `Musys.HVM.Storage.Pointer`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.POINTER`
  - 存储方式: 要求和对应架构的整数布局完全相同. 例如, 64 位系统的指针和 `BiWord` 对齐, 32 位系统的指针和 `Word` 对齐.

#### 浮点数

Musys-HVM 默认支持两种浮点数: IEEE-Float32 和 IEEE-Float64.

- **IEEE-Float32浮点**: 等价于 C 类型 `float`. 在寄存器布局中, IEEE-Float32 浮点和“字”整数的内存占位应当完全相同.
  - 常用指令后缀: `f32`
  - Musys-HVM 类型: `Musys.HVM.Storage.IeeeF32`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.IEEE_F32`
  - 存储方式: 和 32 位的 `Word` 类型布局完全相同.
- **IEEE-Float64浮点**: 等价于 C 类型 `double`. 在寄存器布局中, IEEE-Float64 浮点和"双字"整数的内存占位应当完全相同.
  - 常用指令后缀: `f64`
  - Musys-HVM 类型: `Musys.HVM.Storage.IeeeF64`
  - Musys-HVM 存储类枚举: `Musys.HVM.Storage.TypeID.IEEE_F64`
  - 存储方式: 和 64 位的 `BiWord` 类型布局完全相同.

Musys-HVM 不支持除这两种浮点以外的任意浮点数. 其他浮点数应当转化为可以容纳该浮点的最小整数存储, 并辅以专有的 intrin 指令或者函数. 大于一个寄存器大小的浮点(例如 float128, float80)局部变量应当存储在栈空间而不是寄存器空间.

#### 胖指针

体积大于一个寄存器并发挥寻址功能的类型称为“胖指针”。显然，胖指针是一种拓展类型, 会占据不止一个寄存器. 例如, 数组类型 `int[,,]` 会被编译成:

```c#
public struct<>
Musys.Lang.ArraySlice::<int[,,]> {
    WordT* begin;
    WordT  d0, d1, d2;
}
```

但不是所有数组都会被编译成胖指针. 倘若数组的一部分维度长度已知, 那这部分维度就没必要存储了. 例如, 数组 `int[10]` 会被编译为 `WordT*`, 而数组 `int[,10,11]` 会被编译成这样:

```c#
public struct<>
Musys.Lang.ArraySlice::<int[,10,20]> {
    WordT* begin;
    WordT  d0;
}
```

因为体积太大了, 所以大多数胖指针不会存储在寄存器里, 而是和其他结构体一样存放在栈空间; 函数调用传参时, 胖指针也像其他大结构体一样只传自己的地址. 但是有些时候, 胖指针结构体的不同成员会被全部加载到寄存器里.

### 存储类型 ID

每个存储类型都对应一个"存储类型 ID". 存储类型 ID 是一个范围 [0, 255] 的整数, 对应的类型名称一般是 `Musys.HVM.Storage.TypeID`. 以下是 TypeID 的值列表:

| TypeID 名称    | 值或值域  |  含义       |
| :------------: | :-------: | :---------: |
| NONE           | 0         | 空类型 ID   |
| BYTE           | 1         | Byte 类型   |
| HF_WORD        | 2         | HfWord 类型 |
| WORD           | 3         | Word   类型 |
| BI_WORD        | 4         | BiWord 类型 |
| \<reserved>    | [5, 7]    | *保留给整数* |
| POINTER        | 8         | 指针类型    |
| \<reserved>    | [9, 11]   | *保留给指针* |
| IEEE_F32       | 12        | IeeeF32类型 |
| IEEE_F64       | 13        | IeeeF64类型 |
| \<reserved>    | [14, 255] | *保留字段*  |

### 动态数据类型

反映数据运行期类型的整数, 占用的空间一般和指针相等. 与存储类型不同, 动态数据类型可以存储更多信息——例如, 整数是否有符号、指针是否持有动态内存的所有权等等.

在 Musys 语言的完全体中, 动态数据类型应该是和面向对象挂钩的. 现在用于 Musys-HVM 的动态数据类型只支持几个基础存储类型. 针对基础存储类型的动态数据类型 ID 必须在 [0, 255] 之间, 其中包含整数、浮点、指针等 Musys 基础类型的定义, 还可能包含类对象、胖指针等大类的定义. 受 Vala 语言影响, 这些不超过 255 的动态类型 ID 一般称为 rank (权).

最基础的几个类型分到的权如下所示:

| Rank 值 | 表示的类型   | 描述                   |
| :-----: | :----------: | :--------------------: |
| 0       | None(无类型) | 恒为 0 的类型, 不应当有任何值属于它. 一般表示出了错. 作为函数返回类型时表示该函数永远不会返回. |
| 1       | Unit/void    | 基元类型, 恒为 1 的类型. |
| 2       | bool         | 布尔类型, 只有真(等价于1) 和假(等价于0)两个值. |

#### 整数和浮点类型

整数类型分到了如下几个权:

| Rank 值 | 表示的类型        | Musys-HVM 存储类 | 描述                    |
| :-----: | :---------------: | :--------------: | :---------------------: |
| 4       | char,byte,int8    | Byte             | 字符/字节类型. Musys 采用 UTF-8 编码, 所以一字符为 1 字节. |
| 5       | uchar,ubyte,uint8 | Byte             | 无符号的字符/字节类型.  |
| 6       | short,int16       | HfWord           | 16位短整数类型, [-32768, 32767] 范围内的整数.  |
| 7       | ushort,uint16     | HfWord           | 无符号短整数类型, [0, 65536) 范围内的整数.     |
| 8       | int,int32         | Word             | 32位整数类型, [-2^31, 2^31) 范围内的整数.      |
| 9       | uint,uint32       | Word             | 无符号32位整数类型, [0, 2^32) 范围内的整数.    |
| 10      | long              | 等于字长         | 与字长相同的整数类型       |
| 11      | ulong             | 等于字长         | 与字长相同的无符号整数类型 |
| 12      | int64             | BiWord           | 64位整数类型, [-2^63, 2^63) 范围内的整数.      |
| 13      | uint64            | BiWord           | 无符号64位整数类型, [0, 2^64) 范围内的整数.    |

浮点类型分到了如下几个权:

| Rank 值 | 表示的类型        | Musys-HVM 存储类 | 描述                    |
| :-----: | :---------------: | :--------------: | :---------------------: |
| 16      | float             | IeeeF32          | 单精度浮点类型          |
| 17      | double            | IeeeF64          | 双精度浮点类型          |

#### 指针类型

指针类型分到如下几个权:

| Rank 值 | 表示的类型        | Musys-HVM 存储类 | 描述                    |
| :-----: | :---------------: | :--------------: | :---------------------: |
| 20      | void* (rw-)       | Pointer          | 可读可写的指针          |
| 21      | label (--x)       | Pointer          | 跳转标签(不暴露)        |

### 数据处理

#### 寄存器

#### 算术运算

#### 数组和指针操作

#### 强制类型转换

## 控制流模型

### 基本块和标签

### 静态跳转

### 动态跳转

支持动态跳转的前置条件是支持标签作为值, 因此 Musys-HVM 目前不支持动态跳转. 考虑到以后可能会实现协程, 因此之后 Musys-HVM 可能会加入对动态跳转的支持.

## 函数调用模型

### 函数

### 静态函数调用和返回的控制流

### 动态函数调用和返回的控制流

支持动态函数调用的前置条件是支持函数指针, 因此 Musys-HVM 目前不支持动态函数调用. Musys-HVM 很快会支持动态函数调用. 现在, Musys 会为这类指令预留一系列指令空间. 动态函数调用的指令格式可能会比静态函数调用复杂得多.

### 函数调用阶段的数据流

### 函数返回阶段的数据流

## 对象模型

Musys-HVM 暂时不支持对象模型.